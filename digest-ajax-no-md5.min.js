/*(c) 2014 Kynec Studios, Andrew Mitchell | MIT License opensource.org/licenses/MIT */
(function(a){DigestAjax=function(){};DigestAjax.authHelper=function(){return{username:"",password:""}};DigestAjax.UNAUTH_HA1=null;DigestAjax.AUTH_HA1=null;DigestAjax.UNAUTH_USERNAME=null;DigestAjax.AUTH_USERNAME=null;DigestAjax.WWW_AUTHENTICATE="WWW-Authenticate";DigestAjax.ajaxDigest=function(c,e,f,k){var o={},n,d;var j=document.createElement("a");if(typeof c==="object"){o=c;j.href=o.url}else{if(typeof c==="string"){if(typeof e==="string"){n=e?e:null;d=f?f:null}else{if(typeof e==="object"){o=e?e:{};n=f?f:null;d=k?k:null}}j.href=c;o.url=c}}o=a.extend({requestUri:j.pathname+j.search,username:n,password:d,type:"GET"},o);var m=a.Deferred();return m.promise(l());function l(){return a.ajax(o).done(function(q,r,p){m.resolve(q,r,p)}).fail(function(p,r,q){if(p.status===401||p.status===407){h(g(p))}else{m.reject(p,r,q)}})}function h(p){if(o.headers===undefined){o.headers={}}o.headers.Authorization=p;return a.ajax(o).done(function(r,s,q){if(DigestAjax.UNAUTH_HA1!==null){DigestAjax.AUTH_HA1=DigestAjax.UNAUTH_HA1;DigestAjax.UNAUTH_HA1=null}if(DigestAjax.UNAUTH_USERNAME!==null){DigestAjax.AUTH_USERNAME=DigestAjax.UNAUTH_USERNAME;DigestAjax.UNAUTH_USERNAME=null}m.resolve(r,s,q)}).fail(function(q,s,r){if(q.status===401||q.status===407){DigestAjax.AUTH_HA1=null;DigestAjax.AUTH_USERNAME=null}m.reject(q,s,r)})}function g(D){var v=D.getResponseHeader(DigestAjax.WWW_AUTHENTICATE);if(v!==undefined&&v!==null){var s=b(v);var p=s.qop;var B="auth";if(p!==undefined&&p.toLowerCase()==="auth-int"){B="auth-int"}var x=s.algorithm;var A;var u;var C;if(DigestAjax.AUTH_HA1!==null){A=DigestAjax.AUTH_HA1;u=DigestAjax.AUTH_USERNAME}else{if(o.username===null||o.password===null){var q=a.extend({username:"",password:""},DigestAjax.authHelper());a.extend(o,q)}if(x!==undefined&&x.toLowerCase()==="md5-sess"){C=i();A=CryptoJS.MD5(CryptoJS.MD5(o.username+":"+s.realm+":"+o.password)+":"+s.nonce+":"+C)}else{A=CryptoJS.MD5(o.username+":"+s.realm+":"+o.password)}u=o.username;DigestAjax.UNAUTH_HA1=A;DigestAjax.UNAUTH_USERNAME=o.username}var y,r;if(B==="auth-int"){var w=o.data?o.data:"";y=CryptoJS.MD5(o.type+":"+o.requestUri+":"+CryptoJS.MD5(w))}else{y=CryptoJS.MD5(o.type+":"+o.requestUri)}var r,t;if(s.qop===undefined){r=CryptoJS.MD5(A+":"+s.nonce+":"+y)}else{if(C===undefined){C=i()}t="00000001";r=CryptoJS.MD5(A+":"+s.nonce+":"+t+":"+C+":"+B+":"+y)}var z=[];z.push('Digest username="',u,'",');z.push('realm="',s.realm,'",');z.push('nonce="',s.nonce,'",');z.push('uri="',o.requestUri,'",');z.push("qop=",B,",");if(t!==undefined){z.push("nc=",t,",")}if(C!==undefined){z.push('cnonce="',C,'",')}if(s.opaque!==undefined){z.push('opaque="',s.opaque,'",')}z.push('response="',r,'"');return z.join("")}}function b(s){var r={};var q=/([^"',\s]*)="([^"]*)/gm;var p=null;do{p=q.exec(s);if(p!==null){r[p[1]]=p[2]}}while(p!==null);return r}function i(){var p="abcdef0123456789";var s="";for(var r=0;r<8;r++){var q=Math.floor(Math.random()*p.length);s+=p.substr(q,1)}return s}};DigestAjax.ajaxDigestType=function(e,c,d,f,b){if(typeof d==="string"){b=f;f=d}if(typeof d!=="object"){d={}}d.type=e;return DigestAjax.ajaxDigest(c,d,f,b)};DigestAjax.getDigest=function(c,d,e,b){return DigestAjax.ajaxDigestType("GET",c,d,e,b)};DigestAjax.postDigest=function(c,d,e,b){return DigestAjax.ajaxDigestType("POST",c,d,e,b)};DigestAjax.putDigest=function(c,d,e,b){return DigestAjax.ajaxDigestType("PUT",c,d,e,b)};DigestAjax.deleteDigest=function(c,d,e,b){return DigestAjax.ajaxDigestType("DELETE",c,d,e,b)};a.extend({authHelper:function(b){DigestAjax.authHelper=b},ajaxDigest:DigestAjax.ajaxDigest,ajaxDigestType:DigestAjax.ajaxDigestType,getDigest:DigestAjax.getDigest,postDigest:DigestAjax.postDigest,putDigest:DigestAjax.putDigest,deleteDigest:DigestAjax.deleteDigest})}(jQuery));